<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专辑详情</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1e1e1e;
            color: #ffffff;
        }
        .album-art {
            width: 200px;
            height: 200px;
        }
        .song-list {
            margin-top: 20px;
        }
        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            cursor: pointer;
        }
        .song-item:not(:last-child) {
            border-bottom: 1px solid #444;
        }
        .song-info {
            display: flex;
            align-items: center;
        }
        .song-info .number {
            margin-right: 20px;
            font-size: 20px;
        }
        .song-info .details {
            display: flex;
            flex-direction: column;
        }
        .song-info .details .title {
            font-size: 18px;
        }
        .song-info .details .artist {
            font-size: 14px;
            color: #bbb;
        }
        .song-info .song-art {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
        .liked {
            color: #ff0000;
            cursor: pointer;
        }
        /* 仅在 iframe 中隐藏播放条 */
        @media all and (min-width: 1px) {
            .player-bar {
                display: none;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row my-5">
        <div class="col-md-4">
            <img id="album-art" class="album-art" src="" alt="专辑封面">
        </div>
        <div class="col-md-8">
            <h1 id="album-name">专辑名称</h1>
            <p id="album-year">年代: </p>
            <div id="album-artists" class="mb-3"></div>
            <div id="album-like" class="liked"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <h2>全部播放 (共 <span id="song-count">0</span> 首)</h2>
            <div id="song-list" class="song-list"></div>
        </div>
    </div>
</div>

<script>
    const apiBaseUrl = 'http://127.0.0.1:5000';
    const urlParams = new URLSearchParams(window.location.search);
    const albumUUID = urlParams.get('uuid'); // 从URL参数获取UUID

    if (!albumUUID) {
        document.body.innerHTML = '<h1>缺少专辑UUID参数</h1>';
        throw new Error('缺少专辑UUID参数');
    }

    let currentIndex = 0;
    let songs = [];
    let currentSong = null; // 当前播放的歌曲对象

    async function fetchAlbumData() {
        try {
            const response = await fetch(`${apiBaseUrl}/show_album/${albumUUID}`);
            if (response.ok) {
                const albumData = await response.json();
                console.log('Fetched album data:', albumData); // Log album data
                songs = albumData.songs;
                displayAlbumData(albumData);
            } else {
                console.error('Failed to fetch album data:', response.statusText);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function fetchFile(filePath) {
        try {
            const response = await fetch(`${apiBaseUrl}/getfile?file_path=${encodeURIComponent(filePath)}`);
            if (response.ok) {
                return response.blob();
            } else {
                console.error('Failed to fetch file:', response.statusText);
            }
        } catch (error) {
            console.error('Error:', error);
        }
        return null;
    }

    async function displayAlbumData(album) {
        // 获取专辑封面
        const albumArtBlob = await fetchFile(album.album_art_path);
        if (albumArtBlob) {
            const albumArtUrl = URL.createObjectURL(albumArtBlob);
            document.getElementById('album-art').src = albumArtUrl;
        } else {
            document.getElementById('album-art').src = 'default_cover.png';
        }

        document.getElementById('album-name').textContent = album.name;
        document.getElementById('album-year').textContent = `年代: ${album.year}`;
        updateAlbumLikeButton(album);

        const albumArtists = document.getElementById('album-artists');
        albumArtists.innerHTML = '';
        album.album_artists.forEach(artist => {
            const artistLink = document.createElement('a');
            artistLink.href = `artist.html?uuid=${artist.uuid}`;
            artistLink.textContent = artist.name;
            artistLink.style.color = '#007bff';
            artistLink.style.marginRight = '10px';
            albumArtists.appendChild(artistLink);
        });

        document.getElementById('song-count').textContent = album.songs.length;

        const songList = document.getElementById('song-list');
        songList.innerHTML = '';

        // 按照 disc_number 和 track_number 排序
        album.songs.sort((a, b) => {
            if (a.disc_number === b.disc_number) {
                return a.track_number - b.track_number;
            } else {
                return a.disc_number - b.disc_number;
            }
        });

        // 记录当前的 disc_number
        let currentDiscNumber = -1;

        for (const [index, song] of album.songs.entries()) {
            // 如果当前的 disc_number 发生了变化，添加分隔符
            if (song.disc_number !== currentDiscNumber) {
                currentDiscNumber = song.disc_number;
                const discSeparator = document.createElement('div');
                discSeparator.className = 'disc-separator';
                discSeparator.textContent = `Disc ${currentDiscNumber}`;
                discSeparator.style.margin = '20px 0';
                discSeparator.style.fontWeight = 'bold';
                songList.appendChild(discSeparator);
            }

            const songItem = document.createElement('div');
            songItem.className = 'song-item';
            songItem.id = `song-${song.uuid}`; // 设置ID以便后续更新
            songItem.onclick = (event) => {
                if (event.target.tagName.toLowerCase() !== 'span' && event.target.tagName.toLowerCase() !== 'a') {
                    fetchAndPlaySong(index);
                }
            };

            const songInfo = document.createElement('div');
            songInfo.className = 'song-info';

            const songNumber = document.createElement('div');
            songNumber.className = 'number';
            songNumber.textContent = index + 1;

            const songArt = document.createElement('img');
            songArt.className = 'song-art';
            const songArtBlob = await fetchFile(song.song_art_path);
            if (songArtBlob) {
                const songArtUrl = URL.createObjectURL(songArtBlob);
                songArt.src = songArtUrl;
            } else {
                songArt.src = 'default_cover.png';
            }
            songArt.alt = song.name;

            const songDetails = document.createElement('div');
            songDetails.className = 'details';

            const songTitle = document.createElement('div');
            songTitle.className = 'title';
            songTitle.textContent = song.name;

            const songArtist = document.createElement('div');
            songArtist.className = 'artist';
            song.artists.forEach(artist => {
                const artistLink = document.createElement('a');
                artistLink.href = `artist.html?uuid=${artist.uuid}`;
                artistLink.textContent = artist.name;
                artistLink.style.color = '#007bff';
                artistLink.style.marginRight = '5px';
                songArtist.appendChild(artistLink);
            });

            songDetails.appendChild(songTitle);
            songDetails.appendChild(songArtist);
            songInfo.appendChild(songNumber);
            songInfo.appendChild(songArt);
            songInfo.appendChild(songDetails);

            const songActions = document.createElement('div');
            songActions.className = 'actions';

            const likedIcon = document.createElement('span');
            likedIcon.className = song.is_liked ? 'text-danger liked' : 'liked';
            likedIcon.innerHTML = song.is_liked ? '&#9829;' : '&#9825;';
            likedIcon.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleSongLike(song.uuid);
            });
            songActions.appendChild(likedIcon);

            songItem.appendChild(songInfo);
            songItem.appendChild(songActions);
            songList.appendChild(songItem);
        }
        // 添加底部填充元素
        const paddingElement = document.createElement('div');
        paddingElement.style.height = '100px';
        songList.appendChild(paddingElement);
    }

    function updateAlbumLikeButton(album) {
        const albumLike = document.getElementById('album-like');
        albumLike.innerHTML = album.is_liked ? '喜欢 &#9829;' : '不喜欢 &#9825;';
        albumLike.className = album.is_liked ? 'liked' : 'unliked';
        albumLike.onclick = () => toggleAlbumLike(album);
    }

    async function toggleAlbumLike(album) {
        const uuid = album.uuid;
        try {
            let likeResponse;
            if (album.is_liked) {
                likeResponse = await fetch(`${apiBaseUrl}/unlike_album/${uuid}`);
            } else {
                likeResponse = await fetch(`${apiBaseUrl}/like_album/${uuid}`);
            }

            if (likeResponse.ok) {
                const updatedAlbumResponse = await fetch(`${apiBaseUrl}/show_album/${uuid}`);
                if (updatedAlbumResponse.ok) {
                    const updatedAlbum = await updatedAlbumResponse.json();
                    updateAlbumLikeButton(updatedAlbum);
                }
            } else {
                console.error('Failed to toggle like status for album:', likeResponse.statusText);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function fetchAndPlaySong(index) {
        currentIndex = index;
        const uuid = songs[index].uuid;
        try {
            console.log('Fetching song details for uuid:', uuid); // Log UUID
            const response = await fetch(`${apiBaseUrl}/show_song/${uuid}`);
            if (response.ok) {
                const song = await response.json();
                console.log('Fetched song details:', song); // Log song details
                playSong(song);
            } else {
                console.error('Failed to fetch song details:', response.statusText);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function playSong(song) {
        try {
            console.log('Playing song:', song);
            if (!song.file_path) {
                console.error('Error: song.file_path is undefined');
                return;
            }

            const songUrl = `${apiBaseUrl}/getfile?file_path=${encodeURIComponent(song.file_path)}`;

            // 获取歌曲封面
            const songArtBlob = await fetchFile(song.song_art_path);
            let songArtUrl = 'default_cover.png';
            if (songArtBlob) {
                songArtUrl = URL.createObjectURL(songArtBlob);
            }

            // 发送消息给父窗口以播放歌曲
            window.parent.postMessage({
                action: 'playSong',
                song: {
                    url: songUrl,
                    art: songArtUrl,
                    title: song.name,
                    artists: song.artists.map(artist => ({ name: artist.name, uuid: artist.uuid })),
                    album: song.album.name,
                    albumUUID: song.album.uuid,
                    isLiked: song.is_liked,
                    uuid: song.uuid
                }
            }, '*');

            currentSong = song;
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function toggleSongLike(uuid) {
        try {
            // 获取当前歌曲的最新状态
            const response = await fetch(`${apiBaseUrl}/show_song/${uuid}`);
            if (response.ok) {
                const song = await response.json();
                let likeResponse;
                if (song.is_liked) {
                    likeResponse = await fetch(`${apiBaseUrl}/unlike_song/${uuid}`);
                } else {
                    likeResponse = await fetch(`${apiBaseUrl}/like_song/${uuid}`);
                }

                if (likeResponse.ok) {
                    const updatedSongResponse = await fetch(`${apiBaseUrl}/show_song/${uuid}`);
                    if (updatedSongResponse.ok) {
                        const updatedSong = await updatedSongResponse.json();
                        updateSongListIcon(uuid, updatedSong.is_liked); // 更新列表中的爱心图标
                        if (currentSong && currentSong.uuid === uuid) {
                            currentSong.is_liked = updatedSong.is_liked; // 更新当前播放的歌曲状态
                        }
                    }
                } else {
                    console.error('Failed to toggle like status:', likeResponse.statusText);
                }
            } else {
                console.error('Failed to fetch song details:', response.statusText);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function updateSongListIcon(uuid, isLiked) {
        const songItem = document.getElementById(`song-${uuid}`);
        if (songItem) {
            const likedIcon = songItem.querySelector('.actions span');
            likedIcon.className = isLiked ? 'text-danger liked' : 'liked';
            likedIcon.innerHTML = isLiked ? '&#9829;' : '&#9825;';
        }
    }

    // 处理来自父窗口的消息
    window.addEventListener('message', (event) => {
        if (event.data.action === 'previous') {
            playPreviousSong();
        } else if (event.data.action === 'next') {
            playNextSong();
        } else if (event.data.action === 'toggleLike') {
            toggleLike();
        }
    });

    async function toggleLike() {
        if (!currentSong) {
            console.error('Error: No song is currently being played.');
            return;
        }

        await toggleSongLike(currentSong.uuid);
    }

    let isDebounced = false; // 增加一个防抖动标志

    function playNextSong() {
        if (isDebounced) return; // 如果已经在防抖动期间，则直接返回

        isDebounced = true; // 设置防抖动标志
        setTimeout(() => { isDebounced = false; }, 1000); // 1秒后解除防抖动

        console.log("next song!");
        currentIndex = (currentIndex + 1) % songs.length;
        fetchAndPlaySong(currentIndex);
    }

    function playPreviousSong() {
        if (isDebounced) return; // 如果已经在防抖动期间，则直接返回

        isDebounced = true; // 设置防抖动标志
        setTimeout(() => { isDebounced = false; }, 1000); // 1秒后解除防抖动

        currentIndex = (currentIndex - 1 + songs.length) % songs.length;
        fetchAndPlaySong(currentIndex);
    }

    fetchAlbumData();
    // 处理来自父窗口的消息
    window.addEventListener('message', (event) => {
        if (event.data.action === 'previous') {
            playPreviousSong();
        } else if (event.data.action === 'next') {
            playNextSong();
        } else if (event.data.action === 'toggleLike') {
            toggleLike();
        } else if (event.data.action === 'updateSongLike') {
            updateSongListIcon(event.data.uuid, event.data.isLiked);
        }
    });
</script>

</body>
</html>