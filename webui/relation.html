<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Visualization</title>
    <style>
        #cy {
            width: 100%;
            height: 100vh;
            display: block;
        }
    </style>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
</head>
<body>
    <div id="cy"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var cy = cytoscape({
                container: document.getElementById('cy'),

                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(name)',
                            'width': '40px',
                            'height': '20px',
                            'background-color': '#0074D9',
                            'color': '#000000',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '10px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#cccccc',
                            'target-arrow-color': '#cccccc',
                            'target-arrow-shape': 'triangle'
                        }
                    },
                    {
                        selector: '.highlighted',
                        style: {
                            'background-color': '#FF4136',
                            'line-color': '#FF4136',
                            'target-arrow-color': '#FF4136',
                            'transition-property': 'background-color, line-color, target-arrow-color',
                            'transition-duration': '0.5s'
                        }
                    }
                ],

                elements: {
                    nodes: [], // 在这里放置节点数据
                    edges: []  // 在这里放置边数据
                },

                layout: {
                    name: 'cose',
                    padding: 10,
                    avoidOverlap: true,
                    avoidOverlapPadding: 10
                }
            });

            cy.on('tap', 'node', function (evt) {
                var node = evt.target;
                var neighborhood = node.neighborhood().add(node);

                cy.elements().removeClass('highlighted');
                neighborhood.addClass('highlighted');
            });

            cy.on('dbltap', 'node', function (evt) {
                var node = evt.target;
                window.parent.postMessage({ action: 'navigateTo', url: `artist.html?uuid=${node.id()}` }, '*');
            });

            let apiBaseUrl = 'http://127.0.0.1:5010';
            const urlParams = new URLSearchParams(window.location.search);
            apiBaseUrl = urlParams.get('apibaseUrl');
            let artistUUID = urlParams.get('uuid');
            // 读取 JSON 数据并创建图形
            fetch(`${apiBaseUrl}/show_relation?uuid=${artistUUID}&layer=1`)
                .then(response => response.json())
                .then(data => {
                    var nodes = data.nodes.map(node => ({
                        data: { id: node.uuid, name: node.name }
                    }));
                    var edges = data.edges.map(edge => ({
                        data: { source: edge.source, target: edge.target }
                    }));

                    cy.add(nodes);
                    cy.add(edges);
                    cy.layout({
                        name: 'cose',
                        padding: 10,
                        avoidOverlap: true,
                        avoidOverlapPadding: 10
                    }).run();
                });
        });
    </script>
</body>
</html>