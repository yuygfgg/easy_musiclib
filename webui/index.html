<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主页面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1e1e1e;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        .navbar {
            background-color: #2e2e2e;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
        }
        .navbar a {
            color: #ffffff;
            text-decoration: none;
            font-size: 16px;
            padding: 10px;
        }
        .navbar a:hover {
            background-color: #444;
            border-radius: 5px;
        }
        #content {
            flex: 1;
            overflow: auto;
            padding-bottom: 100px; /* 确保内容不会被播放条挡住 */
        }
        .player-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #2e2e2e;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            z-index: 1000;
        }
        .player-bar img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
        .player-bar .song-details {
            display: flex;
            align-items: center;
        }
        .player-bar .song-details .title {
            font-size: 16px;
        }
        .player-bar .song-details .artist, .player-bar .song-details .album {
            font-size: 12px;
            color: #bbb;
            cursor: pointer;
        }
        .player-controls {
            display: flex;
            align-items: center;
        }
        .player-controls button {
            background: none;
            border: none;
            color: #fff;
            margin: 0 5px;
            font-size: 20px;
            cursor: pointer;
        }
        .progress-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        .progress-bar {
            width: 100%;
            height: 5px;
            background: #444;
            cursor: pointer;
            position: relative;
        }
        .progress {
            height: 100%;
            background: #007bff;
            width: 0;
        }
        .liked {
            color: #ff0000;
            cursor: pointer;
        }
        .input-container {
            padding: 20px;
            background-color: #2e2e2e;
            display: flex;
            justify-content: space-around;
        }
        .input-container input {
            width: 300px;
            padding: 10px;
            border: 1px solid #444;
            background-color: #1e1e1e;
            color: #fff;
        }
        .input-container button {
            padding: 10px 20px;
            background-color: #007bff;
            border: none;
            color: #fff;
            cursor: pointer;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .search-container {
            display: flex;
            align-items: center;
        }
        .search-container input {
            width: 200px;
            padding: 5px;
            margin-right: 5px;
            background-color: #1e1e1e;
            color: #fff;
            border: 1px solid #444;
        }
        .search-container button {
            background-color: transparent;
            border: none;
            cursor: pointer;
        }
</style>
</head>
<body>
    <div class="navbar">
        <div class="input-container">
            <div>
                <input type="text" id="apiBaseUrl" placeholder="输入api服务地址">
                <button onclick="setapiBaseUrl()">设定</button>
            </div>
        </div>
        <div class="search-container">
            <input type="text" id="search-query" placeholder="搜索..." onkeydown="handleSearchKey(event)">
            <button onclick="navigateToSearch()">
                <img src="search.svg" alt="搜索" style="height: 20px;">
            </button>
        </div>
        <a href="#" onclick="navigateToLiked()">我喜欢的</a>
    </div>
<div id="content">
    <iframe id="content-frame" src=""></iframe>
</div>

<div class="player-bar" id="player-bar">
    <div class="song-details">
        <img id="playing-art" src="" alt="歌曲封面">
        <div>
            <div class="title" id="playing-title">歌曲名称</div>
            <div class="artist" id="playing-artists"></div>
            <div class="album" id="playing-album"></div>
        </div>
    </div>
    <div class="player-controls">
        <button id="prev-btn">&#9664;</button>
        <button id="play-pause-btn">&#9654;</button>
        <button id="next-btn">&#9654;&#9654;</button>
        <button id="repeat-btn">&#128257;</button>
        <button id="like-btn">&#9825;</button>
    </div>
    <div class="progress-container">
        <span id="playing-time">00:00</span>
        <div class="progress-bar" id="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        <span id="song-duration">00:00</span>
    </div>
</div>

<audio id="audio-player" src=""></audio>

<script>
    let apiBaseUrl = 'http://127.0.0.1:5000';
    let isPlaying = false;
    let isRepeating = false;
    let currentSongUUID = null;

    function navigateTo(url) {
        const iframe = document.getElementById('content-frame');
        const newUrl = `${url}&apibaseUrl=${encodeURIComponent(apiBaseUrl)}`;
        iframe.src = newUrl;
    }

    function navigateToForLiked(url) {
        const iframe = document.getElementById('content-frame');
        const newUrl = `${url}?apibaseUrl=${encodeURIComponent(apiBaseUrl)}`;
        iframe.src = newUrl;
    }

    function handleSearchKey(event) {
        if (event.key === 'Enter') {
            navigateToSearch();
        }
    }

    function navigateToSearch() {
        const query = document.getElementById('search-query').value;
        if (query) {
            console.log(`Navigating to search.html?query=${encodeURIComponent(query)}`); // Log URL for debugging
            navigateTo(`search.html?query=${encodeURIComponent(query)}`);
        } else {
            alert('请输入搜索关键词');
        }
    }

    function setapiBaseUrl() {
        const query = document.getElementById('apiBaseUrl').value;
        if (query) {
            console.log(`set apibaseUrl to ${encodeURIComponent(query)}`); // Log URL for debugging
            apiBaseUrl=query;
        } else {
            alert('请输入apibaseurl');
        }
    }

    function navigateToLiked() {
        console.log('Navigating to liked.html'); // Log navigation for debugging
        navigateToForLiked('liked.html');
    }

    // 播放器控制逻辑
    const audioPlayer = document.getElementById('audio-player');

    async function playSong(song) {
        try {
            console.log('Playing song:', song);

            // 暂停并重置当前音频
            audioPlayer.pause();
            audioPlayer.src = ''; // 清空当前 src
            audioPlayer.load(); // 重置音频元素

            const streamUrl = `${apiBaseUrl}/getStream?file_path=${encodeURIComponent(song.filePath)}`;
            audioPlayer.src = streamUrl;
            console.log(streamUrl);
            audioPlayer.play();
            isPlaying = true;
            updatePlayPauseButton();

            document.getElementById('playing-art').src = song.art || 'default_cover.png';
            document.getElementById('playing-title').textContent = song.title;

            const artistsHtml = song.artists.map(artist => `<a href="#" onclick="navigateToArtistPage('${artist.uuid}')" style="color: #007bff; margin-right: 5px;">${artist.name}</a>`).join('');
            document.getElementById('playing-artists').innerHTML = artistsHtml;
            document.getElementById('playing-album').innerHTML = `<a href="#" onclick="navigateToAlbumPage('${song.albumUUID}')" style="color: #007bff; margin-left: 10px;">${song.album}</a>`;

            updateLikeButton(song.isLiked);

            audioPlayer.onloadedmetadata = () => {
                document.getElementById('song-duration').textContent = formatTime(audioPlayer.duration);
            };

            audioPlayer.ontimeupdate = () => {
                document.getElementById('playing-time').textContent = formatTime(audioPlayer.currentTime);
                const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                document.getElementById('progress').style.width = `${progressPercent}%`;
            };

            audioPlayer.onended = () => {
                if (isRepeating) {
                    audioPlayer.currentTime = 0;
                    audioPlayer.play();
                } else {
                    playNextSong();
                }
            };

            currentSongUUID = song.uuid;
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function navigateToArtistPage(artistUUID) {
        navigateTo(`artist.html?uuid=${artistUUID}`);
    }

    function navigateToAlbumPage(albumUUID) {
        navigateTo(`album.html?uuid=${albumUUID}`);
    }

    function updatePlayPauseButton() {
        const playPauseBtn = document.getElementById('play-pause-btn');
        playPauseBtn.innerHTML = isPlaying ? '&#10074;&#10074;' : '&#9654;';
    }

    function togglePlayPause() {
        if (isPlaying) {
            audioPlayer.pause();
            isPlaying = false;
        } else {
            audioPlayer.play();
            isPlaying = true;
        }
        updatePlayPauseButton();
    }

    function toggleRepeat() {
        isRepeating = !isRepeating;
        const repeatBtn = document.getElementById('repeat-btn');
        repeatBtn.classList.toggle('active'); // Toggle active class for visual feedback
        repeatBtn.innerHTML = isRepeating ? '&#128258;' : '&#128257;';
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function setProgress(e) {
        const progressBar = document.getElementById('progress-bar');
        const width = progressBar.clientWidth;
        const clickX = e.offsetX;
        const duration = audioPlayer.duration;

        audioPlayer.currentTime = (clickX / width) * duration;
    }

    function updateLikeButton(isLiked) {
        const likeBtn = document.getElementById('like-btn');
        if (isLiked) {
            likeBtn.innerHTML = '&#9829;';
            likeBtn.classList.add('text-danger');
        } else {
            likeBtn.innerHTML = '&#9825;';
            likeBtn.classList.remove('text-danger');
        }
    }

    async function toggleSongLike() {
        if (!currentSongUUID) {
            console.error('Error: No song is currently being played.');
            return;
        }

        try {
            const response = await fetch(`${apiBaseUrl}/show_song/${currentSongUUID}`);
            if (response.ok) {
                const song = await response.json();
                let likeResponse;
                if (song.is_liked) {
                    likeResponse = await fetch(`${apiBaseUrl}/unlike_song/${currentSongUUID}`);
                } else {
                    likeResponse = await fetch(`${apiBaseUrl}/like_song/${currentSongUUID}`);
                }

                if (likeResponse.ok) {
                    const updatedSongResponse = await fetch(`${apiBaseUrl}/show_song/${currentSongUUID}`);
                    if (updatedSongResponse.ok) {
                        const updatedSong = await updatedSongResponse.json();
                        updateLikeButton(updatedSong.is_liked);
                        // 发送消息给 iframe 更新列表中的爱心图标
                        const iframe = document.getElementById('content-frame').contentWindow;
                        iframe.postMessage({ action: 'updateSongLike', uuid: currentSongUUID, isLiked: updatedSong.is_liked }, '*');
                    }
                } else {
                    console.error('Failed to toggle like status:', likeResponse.statusText);
                }
            } else {
                console.error('Failed to fetch song details:', response.statusText);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
    function playNextSong() {
        const iframe = document.getElementById('content-frame').contentWindow;
        iframe.postMessage({ action: 'next' }, '*');
    }

    document.getElementById('prev-btn').addEventListener('click', () => {
        const iframe = document.getElementById('content-frame').contentWindow;
        iframe.postMessage({ action: 'previous' }, '*');
    });

    document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
    document.getElementById('next-btn').addEventListener('click', () => {
        const iframe = document.getElementById('content-frame').contentWindow;
        console.log("next song message sent!")
        iframe.postMessage({ action: 'next' }, '*');
    });
    document.getElementById('repeat-btn').addEventListener('click', toggleRepeat);
    document.getElementById('like-btn').addEventListener('click', toggleSongLike);
    document.getElementById('progress-bar').addEventListener('click', setProgress);

    // 接收来自 iframe 的消息
    window.addEventListener('message', (event) => {
        if (event.data.action === 'playSong') {
            playSong(event.data.song);
        } else if (event.data.action === 'navigateTo') {
            navigateTo(event.data.url);
        }
    });
</script>

</body>
</html>